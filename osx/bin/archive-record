#!/usr/bin/env zsh

set -e
set -u
set -o pipefail
[[ -n "${DEBUG:-}" ]] && set -x

main() {
  emulate -L zsh
  set -e
  set -u
  set -o pipefail

  local shortcuts="$HOME/.config/podman-scripts/shortcuts_path.zsh"
  [[ -r "$shortcuts" ]] || die "Missing shortcuts file: $shortcuts"

  . "$shortcuts"

  local src="${1:-}"
  [[ -n "$src" ]] || die "No input directory path provided"
  [[ -r "$src" ]] || die "Input not readable: $src"

  local rname="${2:-}"
  [[ -n "$rname" ]] || die "No record name provided"
  [[ -r "$rname" ]] || die "Record name not readable: $rname"

  command -v caffeinate >/dev/null 2>&1 || die "caffeinate not found"
  command -v birthrname >/dev/null 2>&1 || die "birthrname not found"
  command -v rpush      >/dev/null 2>&1 || die "rpush not found"

  caffeinate -dims -w $$ &
  birthrname "$src"
  rpush move "$src/" "smb://0819870.xyz/convert/$rname/"
}

die() { print -u2 -- "$@"; exit 2; }

main "$@"