#!/bin/sh
# use-scripts-machine â€” keep the Podman machine awake while a process runs.
# Usage: use-scripts-machine pid

set -eu
[ "${DEBUG:-}" ] && set -x

if [ "$#" -ne 1 ]; then
    echo "usage: use-scripts-machine pid" >&2
    exit 2
fi

pid=$1
case "$pid" in
    ''|*[!0-9]*) echo "invalid pid: $pid" >&2; exit 2 ;;
esac

command -v nc >/dev/null 2>&1 || { echo "nc not found" >&2; exit 127; }

uid=$(id -u)
sock="${DR_PODMAN_SOCK:-${PODMAN_SOCK:-/tmp/com.nashspence.scripts.podman-machine.${uid}.sock}}"

nc -U "$sock" </dev/null >/dev/null &
sock_pid=$!

cleanup() {
    kill "$sock_pid" 2>/dev/null || true
    wait "$sock_pid" 2>/dev/null || true
}
trap cleanup EXIT INT HUP TERM

# ensure connection succeeded
sleep 0.1
if ! kill -0 "$sock_pid" 2>/dev/null; then
    wait "$sock_pid" 2>/dev/null || true
    echo "failed to connect to $sock" >&2
    exit 1
fi

while kill -0 "$pid" 2>/dev/null; do
    sleep 15 || break
done
