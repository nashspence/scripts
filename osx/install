#!/bin/sh
# install: install / uninstall activation + tooling + brew/podman/machine
# Usage:
#   ./install                 # Install everything (activation + PATH + brew/podman/machine)
#   ./install --uninstall     # Remove EVERYTHING this script installed (incl. Podman machine)

set -eu

[ -n "${DEBUG:-}" ] && set -x

# ---- paths / config ----
script_dir=$(CDPATH='' cd -- "$(dirname -- "$0")" && pwd -P)
repo_dir=${REPO_DIR:-$(cd "${script_dir}/.." && pwd -P)}
la_dir="${HOME}/Library/LaunchAgents"
uid_name=$(id -un)
uid_num=$(id -u)
osxbin_dir="${script_dir}/bin"

machine=${MACHINE:-com.nashspence.scripts}
podman_cpus=${PODMAN_CPUS:-14}
podman_mem=${PODMAN_MEM:-20480}
podman_disk=${PODMAN_DISK:-40}

path_begin="# >>> podman-scripts PATH >>>"
path_end="# <<< podman-scripts PATH <<<"
export_repo_line="export PODMAN_SCRIPTS_DIR=\"${repo_dir}\""
source_lib_line=". \"\${PODMAN_SCRIPTS_DIR}/osx/lib.sh\""

die() {
    printf 'ERROR: %s\n' "$*" >&2
    exit 1
}

add_path_block() {
    file=$1
    [ -f "${file}" ] || : >"${file}"
    if ! grep -Fqx "${path_begin}" "${file}" 2>/dev/null; then
        {
            printf '\n%s\n' "${path_begin}"
            printf '%s\n' "${export_repo_line}"
            printf '%s\n' "${source_lib_line}"
            printf '%s\n' "${path_end}"
        } >>"${file}"
        printf '  + added PATH block to %s\n' "${file#"${HOME}/"}"
    fi
}

remove_path_block() {
    file=$1
    [ -f "${file}" ] || return 0
    tmp=$(mktemp)
    awk -v b="${path_begin}" -v e="${path_end}" '
        $0==b {skip=1}
        !skip {print}
        $0==e {skip=0}
    ' "${file}" >"${tmp}"
    mv "${tmp}" "${file}"
}

ensure_brew() {
    if command -v brew >/dev/null 2>&1; then
        return 0
    fi
    if [ -x /opt/homebrew/bin/brew ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)" || true
        return 0
    fi
    if [ -x /usr/local/bin/brew ]; then
        eval "$(/usr/local/bin/brew shellenv)" || true
        return 0
    fi
    echo "Homebrew not found — installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c \
        "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [ -x /opt/homebrew/bin/brew ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)" || true
    elif [ -x /usr/local/bin/brew ]; then
        eval "$(/usr/local/bin/brew shellenv)" || true
    fi
    command -v brew >/dev/null 2>&1 || die "brew installation appears to have failed"
}

ensure_podman() {
    if command -v podman >/dev/null 2>&1; then
        return 0
    fi
    echo "Installing Podman with Homebrew…"
    brew list podman >/dev/null 2>&1 || brew install podman
    command -v podman >/dev/null 2>&1 || die "podman not found after installation"
}

ensure_podman_machine() {
    if podman machine inspect "${machine}" >/dev/null 2>&1; then
        return 0
    fi
    echo "Creating Podman machine '${machine}' (cpus=${podman_cpus}, mem=${podman_mem}MB, disk=${podman_disk}GB)…"
    podman machine init \
        -v /Users:/Users -v /Volumes:/Volumes \
        --cpus "${podman_cpus}" \
        --memory "${podman_mem}" \
        --disk-size "${podman_disk}" \
        "${machine}"
    # do not start the machine; the launch agent or user will handle it
}

remove_podman_machine() {
    if podman machine inspect "${machine}" >/dev/null 2>&1; then
        podman machine stop "${machine}" >/dev/null 2>&1 || true
        podman machine rm -f "${machine}" >/dev/null 2>&1 || true
    fi
}

install_launch_agent() {
    dir=$1
    plist_src=$(find "${dir}" -maxdepth 1 -name '*.plist' | head -n1)
    [ -n "${plist_src}" ] || die "missing plist in ${dir}"
    label=$(basename "${plist_src}" .plist)
    plist="${la_dir}/${label}.plist"

    mkdir -p "${la_dir}"

    sed -e "s|%UID%|$uid_name|g" \
        -e "s|%UID_NUM%|$uid_num|g" \
        -e "s|%MACHINE%|$machine|g" \
        -e "s|%REPO_DIR%|$repo_dir|g" \
        "${plist_src}" >"${plist}"
    chmod 644 "${plist}"

    launchctl bootout "gui/${uid_num}" "${plist}" >/dev/null 2>&1 || true
    launchctl bootstrap "gui/${uid_num}" "${plist}"
    launchctl kickstart -k "gui/${uid_num}/${label}" >/dev/null 2>&1 || true

    printf 'Loaded %s LaunchAgent.\n' "${label}"
}

uninstall_launch_agent() {
    dir=$1
    plist_src=$(find "${dir}" -maxdepth 1 -name '*.plist' | head -n1)
    [ -n "${plist_src}" ] || return 0
    label=$(basename "${plist_src}" .plist)
    plist="${la_dir}/${label}.plist"

    launchctl bootout "gui/${uid_num}" "${plist}" >/dev/null 2>&1 || true
    rm -f "${plist}"

    case "$label" in
        com.nashspence.scripts.podman-machine)
            rm -rf "$dir/data" 2>/dev/null || true
            ;;
    esac
}

install_launch_agents() {
    for dir in "${script_dir}/launch-agents"/*; do
        [ -d "${dir}" ] || continue
        install_launch_agent "${dir}"
    done
}

uninstall_launch_agents() {
    for dir in "${script_dir}/launch-agents"/*; do
        [ -d "${dir}" ] || continue
        uninstall_launch_agent "${dir}"
    done
}


install_all() {
    [ -d "${osxbin_dir}" ] || die "required directory missing: ${osxbin_dir} (must contain 'use-scripts-machine' and 'nsimg')"
    [ -f "${osxbin_dir}/use-scripts-machine" ] || die "required tool missing: ${osxbin_dir}/use-scripts-machine"
    [ -f "${osxbin_dir}/nsimg" ] || die "required tool missing: ${osxbin_dir}/nsimg"
    chmod +x "${osxbin_dir}/use-scripts-machine" 2>/dev/null || true
    chmod +x "${osxbin_dir}/nsimg" 2>/dev/null || true

    [ -d "${script_dir}/launch-agents" ] || die "missing directory: ${script_dir}/launch-agents"
    for dir in "${script_dir}/launch-agents"/*; do
        [ -d "${dir}" ] || continue
        plist=$(find "${dir}" -maxdepth 1 -name '*.plist' | head -n1)
        [ -f "${plist}" ] || die "missing plist in: ${dir}"
        if ! find "${dir}" -maxdepth 1 -type f ! -name '*.plist' | read -r _; then
            die "missing agent file in: ${dir}"
        fi
    done

    mkdir -p "${la_dir}"

    add_path_block "${HOME}/.zprofile"
    add_path_block "${HOME}/.zshrc"

    ensure_brew
    ensure_podman
    ensure_podman_machine

    install_launch_agents

    echo "Install complete."
}

uninstall_all() {
    echo "Uninstalling EVERYTHING this script installed…"

    uninstall_launch_agents

    sock="/tmp/com.nashspence.scripts.podman-machine.${uid_num}.sock"
    [ -S "${sock}" ] && rm -f "${sock}"

    remove_path_block "${HOME}/.zprofile"
    remove_path_block "${HOME}/.zshrc"

    remove_podman_machine

    echo "Uninstall complete."
}

if [ "$#" -eq 1 ] && [ "$1" = "--uninstall" ]; then
    uninstall_all
elif [ "$#" -eq 0 ]; then
    install_all
else
    cat <<USAGE >&2
Usage:
  $0                 Install activation + add paths + brew/podman/machine
  $0 --uninstall     Remove EVERYTHING this script installed (incl. Podman machine)
USAGE
    exit 2
fi
