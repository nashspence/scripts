repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-yaml
      - id: check-executables-have-shebangs
  - repo: https://github.com/psf/black
    rev: 24.4.2
    hooks:
      - id: black
        language_version: python3
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: [--profile=black]
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        args: [--max-line-length=88, --extend-ignore=E501]
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        args: [--namespace-packages, --strict]
        additional_dependencies:
          - types-Pillow
          - types-python-dateutil
          - pycdlib
          - pytest>=8
  - repo: local
    hooks:
      - id: gauge-format
        name: gauge format
        language: system
        entry: |
          bash -euo pipefail -c '
            VERSION=1.6.20
            CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/gauge"
            BIN="$CACHE/gauge"
            GAUGE_HOME="$CACHE/home"
            bin_version=""
            if [ -x "$BIN" ]; then
              set +o pipefail
              bin_version="$($BIN --version 2>/dev/null | head -n1 | cut -d" " -f3)" || true
              set -o pipefail
            fi
            if [ "$bin_version" != "$VERSION" ]; then
              rm -f "$BIN"
            fi
            if [ ! -x "$BIN" ]; then
              TMP=$(mktemp -d)
              OS=$(uname -s)
              ARCH=$(uname -m)
              case "$OS-$ARCH" in
                Linux-x86_64) SUFFIX=linux.x86_64 ;;
                Linux-aarch64|Linux-arm64) SUFFIX=linux.arm64 ;;
                Darwin-x86_64) SUFFIX=darwin.x86_64 ;;
                Darwin-arm64) SUFFIX=darwin.arm64 ;;
                *) echo "Unsupported platform: $OS $ARCH" >&2; exit 1 ;;
              esac
              URL="https://github.com/getgauge/gauge/releases/download/v${VERSION}/gauge-${VERSION}-${SUFFIX}.zip"
              curl -fsSL "$URL" -o "$TMP/gauge.zip"
              mkdir -p "$CACHE"
              unzip -oq "$TMP/gauge.zip" -d "$CACHE"
              chmod +x "$BIN"
              rm -rf "$TMP"
            fi
            mkdir -p "$GAUGE_HOME"
            "$BIN" config check_updates false >/dev/null 2>&1 || true
            temp_manifest=
            if [ ! -f manifest.json ]; then
              printf "{\n  \"Language\": \"python\",\n  \"Plugins\": []\n}\n" > manifest.json
              temp_manifest=manifest.json
            fi
            trap "test -n \"$temp_manifest\" && rm -f \"$temp_manifest\"" EXIT
            exec env GAUGE_TELEMETRY_ENABLED=false GAUGE_HOME="$GAUGE_HOME" "$BIN" format "$@"
          ' --
        files: (^|/)spec\.md$
