repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: check-executables-have-shebangs
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.9.0-1
    hooks:
      - id: shfmt
        args: [-w, -i, '4', -ci, -bn]
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        args: [--shell=sh]
  - repo: local
    hooks:
      - id: gauge-format
        name: gauge format
        language: system
        entry: |
          bash -euo pipefail -c '
            VERSION=1.6.20
            CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/gauge"
            BIN="$CACHE/gauge"
            GAUGE_HOME="$CACHE/home"
            bin_version=""
            if [ -x "$BIN" ]; then
              set +o pipefail
              bin_version="$($BIN --version 2>/dev/null | head -n1 | cut -d" " -f3)" || true
              set -o pipefail
            fi
            if [ "$bin_version" != "$VERSION" ]; then
              rm -f "$BIN"
            fi
            if [ ! -x "$BIN" ]; then
              TMP=$(mktemp -d)
              OS=$(uname -s)
              ARCH=$(uname -m)
              case "$OS-$ARCH" in
                Linux-x86_64) SUFFIX=linux.x86_64 ;;
                Linux-aarch64|Linux-arm64) SUFFIX=linux.arm64 ;;
                Darwin-x86_64) SUFFIX=darwin.x86_64 ;;
                Darwin-arm64) SUFFIX=darwin.arm64 ;;
                *) echo "Unsupported platform: $OS $ARCH" >&2; exit 1 ;;
              esac
              URL="https://github.com/getgauge/gauge/releases/download/v${VERSION}/gauge-${VERSION}-${SUFFIX}.zip"
              curl -fsSL "$URL" -o "$TMP/gauge.zip"
              mkdir -p "$CACHE"
              unzip -oq "$TMP/gauge.zip" -d "$CACHE"
              chmod +x "$BIN"
              rm -rf "$TMP"
            fi
            mkdir -p "$GAUGE_HOME"
            "$BIN" config check_updates false >/dev/null 2>&1 || true
            temp_manifest=
            if [ ! -f manifest.json ]; then
              printf "{\n  \"Language\": \"shell\",\n  \"Plugins\": []\n}\n" > manifest.json
              temp_manifest=manifest.json
            fi
            trap "test -n \"$temp_manifest\" && rm -f \"$temp_manifest\"" EXIT
            exec env GAUGE_TELEMETRY_ENABLED=false GAUGE_HOME="$GAUGE_HOME" "$BIN" format "$@"
          ' --
        files: (^|/)spec\.md$
